<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ECS 上的 git 管理工具踩坑记 | Elizur_Blog</title>
    <meta name="description" content="一个不善表达的闷骚前端的个人小空间">
    <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.33d1fe29.css" as="style"><link rel="preload" href="/assets/js/app.5d55d55f.js" as="script"><link rel="preload" href="/assets/js/20.1ba9905a.js" as="script"><link rel="prefetch" href="/assets/js/9.9e283a89.js"><link rel="prefetch" href="/assets/js/2.285762ea.js"><link rel="prefetch" href="/assets/js/3.bb1fba44.js"><link rel="prefetch" href="/assets/js/4.a530815d.js"><link rel="prefetch" href="/assets/js/5.0d9e80ab.js"><link rel="prefetch" href="/assets/js/6.b8f578b0.js"><link rel="prefetch" href="/assets/js/7.45a3569f.js"><link rel="prefetch" href="/assets/js/8.8c5f7c2e.js"><link rel="prefetch" href="/assets/js/10.f70559e0.js"><link rel="prefetch" href="/assets/js/11.14b41240.js"><link rel="prefetch" href="/assets/js/12.4463fe0f.js"><link rel="prefetch" href="/assets/js/13.c83817e9.js"><link rel="prefetch" href="/assets/js/14.3a6d5c00.js"><link rel="prefetch" href="/assets/js/15.6a68f6d6.js"><link rel="prefetch" href="/assets/js/16.3c2359f1.js"><link rel="prefetch" href="/assets/js/17.b55d4c3d.js"><link rel="prefetch" href="/assets/js/18.ad8b8cc9.js"><link rel="prefetch" href="/assets/js/19.6b8d4106.js">
    <link rel="stylesheet" href="/assets/css/0.styles.33d1fe29.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Elizur_Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/react/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/frontend/vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/frontend/wx/mpvue-wx-mini-app-first-look.html" class="nav-link">微信小程序</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/node/" class="nav-link">Node.js</a></li><li class="dropdown-item"><!----> <a href="/backend/koa/" class="nav-link">Koa</a></li><li class="dropdown-item"><!----> <a href="/backend/mongodb/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">AI</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ai/machine-learning/" class="nav-link">机器学习</a></li><li class="dropdown-item"><!----> <a href="/ai/data-mining/" class="nav-link">数据挖掘</a></li></ul></div></div><div class="nav-item"><a href="/ops/" class="nav-link router-link-active">运维/部署</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/react/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/frontend/vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/frontend/wx/mpvue-wx-mini-app-first-look.html" class="nav-link">微信小程序</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/node/" class="nav-link">Node.js</a></li><li class="dropdown-item"><!----> <a href="/backend/koa/" class="nav-link">Koa</a></li><li class="dropdown-item"><!----> <a href="/backend/mongodb/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">AI</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ai/machine-learning/" class="nav-link">机器学习</a></li><li class="dropdown-item"><!----> <a href="/ai/data-mining/" class="nav-link">数据挖掘</a></li></ul></div></div><div class="nav-item"><a href="/ops/" class="nav-link router-link-active">运维/部署</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>运维/部署</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/ops/" class="sidebar-link">运维</a></li><li><a href="/ops/c-s-ops.html" class="sidebar-link">前后端分离项目在阿里云/七牛云的简单部署</a></li><li><a href="/ops/docker-ops.html" class="sidebar-link">前后端分离项目的容器化</a></li><li><a href="/ops/remote-private-git-first-look.html" class="active sidebar-link">ECS 上的 git 管理工具踩坑记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ops/remote-private-git-first-look.html#gitlab" class="sidebar-link">gitlab</a></li><li class="sidebar-sub-header"><a href="/ops/remote-private-git-first-look.html#gogs" class="sidebar-link">gogs</a></li></ul></li><li><a href="/ops/domain-and-website-approve.html" class="sidebar-link">关于域名和备案</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="ecs-上的-git-管理工具踩坑记"><a href="#ecs-上的-git-管理工具踩坑记" aria-hidden="true" class="header-anchor">#</a> ECS 上的 git 管理工具踩坑记</h1> <h2 id="gitlab"><a href="#gitlab" aria-hidden="true" class="header-anchor">#</a> gitlab</h2> <h3 id="在-centos-上安装-gitlab"><a href="#在-centos-上安装-gitlab" aria-hidden="true" class="header-anchor">#</a> 在 CentOS 上安装 gitlab</h3> <p>参考 <a href="https://blog.csdn.net/caib1109/article/details/51756246" target="_blank" rel="noopener noreferrer">8小时外实践系列(六) - 在阿里云服务器上搭建GitLab(草稿) - CSDN博客<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <blockquote><p>gitlab 非常吃性能，在1核1G的服务器上安装后会导致机子非常卡，同时域名/IP访问也会出现502，查资料之后发现是配置太低的问题。官方推荐的配置是2核心8G内存，我们普通个人用户显然难以支付这么昂贵的服务器配置，更不用说海外主机了。</p></blockquote> <h3 id="使用-docker-部署-gitlab"><a href="#使用-docker-部署-gitlab" aria-hidden="true" class="header-anchor">#</a> 使用 docker 部署 gitlab</h3> <p>只需要在 docker hub 中 <code>docker pull gitlab/gitlab-ce</code> 就行，然后我启动容器的的代码如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> docker run --detach \ 
  --hostname gitlab.mydomain.com \ 
  --publish 8443:443 --publish 80:80 --publish 2222:22 \ 
  --name gitlab \ 
  --restart always \ 
  --volume /srv/gitlab/config:/etc/gitlab \ 
  --volume /srv/gitlab/logs:/var/log/gitlab \ 
  --volume /srv/gitlab/data:/var/opt/gitlab \ 
  gitlab/gitlab-ce
</code></pre></div><p>如需修改 gitlab.rb 的配置，只需要 <code>vim /srv/gitlab/config/gitlab.rb</code> 。</p> <p>一般需要配置的有：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>external_url <span class="token string">'你的域名或者IP'</span> <span class="token comment"># 改成你的域名或者 IP，如果你的端口映射不是 80，那也不能在这里加端口</span>
gitlab_rails<span class="token punctuation">[</span><span class="token string">'gitlab_shell_ssh_port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> 2222 <span class="token comment"># 防止和本机 22 端口冲突</span>
unicorn<span class="token punctuation">[</span><span class="token string">'port'</span><span class="token punctuation">]</span> <span class="token operator">=</span> 8999 <span class="token comment"># 如果你的 8080 端口被占用的话</span>
</code></pre></div><p><strong>另外记住，如果单开某个端口，需要在 ECS 实例的安全组中允许这个端口被某个或者某些 IP 访问。</strong></p> <p>配置完成之后需要在容器中 reconfigure: <code>docker exec -it gitlab gitlab-ctl reconfigure</code></p> <blockquote><p>然而我按照上面的方式完成之后，通过域名或者 IP 进入仍是 502。
后来我尝试了在不同机子上部署。例如在群辉 DS218+ 上用同样的方式配置会出现 容器意外停止 的问题；在我的 iMac 本机上用 docker 部署就可以正常访问和进行代码管理</p></blockquote> <h2 id="gogs"><a href="#gogs" aria-hidden="true" class="header-anchor">#</a> gogs</h2> <p>gogs 不像 gitlab 那样吃性能，功能也很完善，不过 gogs 需要有额外的数据库依赖，如 MySQL。具体的部署方式参考以下两篇文章：</p> <p><a href="https://www.jianshu.com/p/5f5e419b5de8" target="_blank" rel="noopener noreferrer">docker安装mysql - 简书<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://www.jianshu.com/p/2a7acb07b352" target="_blank" rel="noopener noreferrer">docker安装gogs - 简书<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <blockquote><p>勘误：在《docker安装mysql - 简书》中，创建网络的命令不是 <code>docker create network backend</code> 而是 <code>docker network create backend</code></p></blockquote> <p>我的容器启动代码如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 启动 MySQL</span>
docker run -d --name mysql57 \
--net<span class="token operator">=</span>backend \ <span class="token comment"># 加入创建的 backend 网络中</span>
-p 3306:3306 \
-e MYSQL_ROOT_PASSWORD<span class="token operator">=</span>root \
-v /srv/mysql/data:/var/lib/mysql \
-v /srv/mysql/conf:/etc/mysql/conf.d \
<span class="token comment"># 启动 gogs</span>
docker run -d \
-p 10022:22 -p 3000:3000 \
--name<span class="token operator">=</span>gogs \
--net<span class="token operator">=</span>backend \ <span class="token comment"># 加入创建的 backend 网络中</span>
-v /srv/gogs/:/data gogs/gogs
</code></pre></div><p>此时访问服务器的 3000 端口即可进入设置界面，记住要把 localhost 全部改成服务器ip。</p> <h3 id="关于-gogs-的数据库设置"><a href="#关于-gogs-的数据库设置" aria-hidden="true" class="header-anchor">#</a> 关于 gogs 的数据库设置</h3> <p>首先由于本例使用了 docker network，所以可以直接使用 容器名:端口 来访问，例如 mysql57:3306。</p> <p>另外我们需要在 mysql 容器中创建一个数据库，否则 gogs 无法完成设置。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker <span class="token function">exec</span> -it mysql57 /bin/bash
mysql -u root -p
<span class="token comment"># 然后输入密码，如果你没更改密码，则密码是 root</span>
</code></pre></div><p>接着在 mysql 命令行中创建数据库，gogs 默认数据库名就是 gogs</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> gogs<span class="token punctuation">;</span>
</code></pre></div><p>接着我们在网页中就可以完成 gogs 的初始化设置了。</p> <p>如果想要使用 gogs，首先我们要注册一个账号，注意第一个注册的账号默认是拥有最高权限的账号。</p> <blockquote><p>在实际使用中，我遇到了 git clone 时发现有 not a repository 的问题，可能是IP/域名、端口等等设置的问题，仍在研究中</p></blockquote> <hr> <p>参考：</p> <ol><li><a href="https://blog.csdn.net/caib1109/article/details/51756246" target="_blank" rel="noopener noreferrer">8小时外实践系列(六) - 在阿里云服务器上搭建GitLab(草稿) - CSDN博客<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.jianshu.com/p/5f5e419b5de8" target="_blank" rel="noopener noreferrer">docker安装mysql - 简书<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.jianshu.com/p/2a7acb07b352" target="_blank" rel="noopener noreferrer">docker安装gogs - 简书<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2018-9-16 15:49:37</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/ops/docker-ops.html" class="prev">
          前后端分离项目的容器化
        </a></span> <span class="next"><a href="/ops/domain-and-website-approve.html">
          关于域名和备案
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/20.1ba9905a.js" defer></script><script src="/assets/js/app.5d55d55f.js" defer></script>
  </body>
</html>
